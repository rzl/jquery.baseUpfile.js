!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof exports?module.exports=t(require("jquery")):e.BaseUpfile=t(e.jQuery)}(this,function(e){"use strict";function t(n){function s(e){if(e.length){for(var t=0;t<e.length;t++){var o=e[t];l.initFile(o),a.onBeforeAddFile(o);var i=l.findFile(o);i<0?(o.fileIndex=l.files.length,"faile"!=o.state&&(l.files.push(o),a.onAddFile(o))):("disable"==l.files[i].state&&(l.enableFile(l.files[i]),a.onAddFile(l.files[i])),a.onSameFile(l.files[i]))}a.onLoadFile(l.files)}}var l=this;this.opt=e.extend({},o,n),this.opt.preSize=1024*this.opt.preSize,this.files=[],this.shareData=i;var a=l.opt;if(a.drop){function p(e){e.originalEvent.stopPropagation(),e.originalEvent.preventDefault()}e(a.dropId).bind("dragenter",p).bind("dragover",p).bind("drop",function(e){p(e),s(e.originalEvent.dataTransfer.files)})}e(a.inputButton).length&&(e(a.inputButton).attr("accept",a.accept),e(a.inputButton).on("change",function(){s(this.files),e(a.inputButton).val("")})),t.prototype.setAccept=function(t){e(this.opt.inputButton).attr("accept",t)},t.prototype.initFile=function(e){return"File"!=e.constructor.name&&alert("not a file obj"),e.fileType=e.fileType?e.fileType:e.type,e.state="stop",e.lock=!1,e.sendIndex=l.getFileSendIndexCache(e),e.blockCount=Math.ceil(e.size/this.opt.preSize),0==e.size&&(a.onUploadError(e,"2"),e.state="faile"),this},t.prototype.disableFile=function(e){this.setFileState(e,"disable")},t.prototype.disableFileByIndex=function(e){this.disableFile(this.files[e])},t.prototype.enableFile=function(e){this.setFileState(e,"stop")},t.prototype.findFile=function(e){for(var t=this.files,o=0;o<t.length;o++)if("object"==typeof t[o]&&t[o].name===e.name&&t[o].lastModified===e.lastModified)return o;return-1},t.prototype.uploadFile=function(t){if(!t.lock){t.lock=!0;var o=this,i=o.opt;if(t.state&&void 0!=t.sendIndex&&t.blockCount||(console.log("文件未被初始化，不能上传"),t.lock=!1,i.onUploadError(t,"0")),0==t.size)return t.lock=!1,void i.onUploadError(t,"2");switch(t.state){case"disable":case"faile":return t.lock=!1,void i.onUploadError(t,"1")}if(t.sendIndex=parseInt(this.getFileSendIndexCache(t)),t.blockCount<=t.sendIndex){i.onUploading(t),this.setFileState(t,"done"),i.onUploadDone(t),t.lock=!1;var n=this.state();n.doneCount==n.enableCount&&i.onUploadAllDone(n)}else{var s,l=new FormData;t.size-t.sendIndex*i.preSize>i.preSize?s=t.slice(t.sendIndex*i.preSize,(parseInt(t.sendIndex)+1)*i.preSize):(s=t.slice(t.sendIndex*i.preSize,t.size),l.append("blockCount",t.blockCount),l.append("fileSize",t.size),i.onLastBlockIndex(t,l)),l.append("file",s),l.append("blockIndex",t.sendIndex),l.append("fileName",t.name),i.onUploading(t,l),e.ajax({type:"post",url:o.opt.uploadURL,data:l,dataType:"json",contentType:!1,processData:!1,success:function(e){e.state||"true"==e.state?(t.sendIndex=parseInt(t.sendIndex)+1,o.setFileSendIndexCache(t)):(console.log("error"),o.setFileState(t,"stop"),o.opt.onUploadError(t,"4",e)),t.lock=!1,"stop"!=t.state?o.uploadFile(t):o.opt.onUploadStop(t)},error:function(e){t.lock=!1,o.setFileState(t,"stop"),o.opt.onUploadError(t,"3",e)}})}}},t.prototype.uploadFileByIndex=function(e){this.uploadFile(this.files[e],frist)},t.prototype.stopUploadFile=function(e){this.setFileState(e,"stop")},t.prototype.stopUploadFileByIndex=function(e){this.setFileState(this.files[e],"stop")},t.prototype.startUploadFile=function(e){if(this.state().uploadingCount<this.opt.queueSize){if("uploading"==e.state)return;this.setFileState(e,"uploading"),this.uploadFile(e)}else this.setFileState(e,"wait")},t.prototype.startUploadFileByIndex=function(e){this.startUploadFile(this.files[e])},t.prototype.queueNext=function(){if(this.state().uploadingCount<this.opt.queueSize){for(var e=0;e<this.files.length;e++)if("wait"==this.files[e].state){var t=this.files[e];break}void 0!=t&&this.startUploadFile(t)}},t.prototype.getFileSendIndexCache=function(e){var t=window.localStorage.getItem(this.opt.key+e.name+e.lastModified);return t=t||0},t.prototype.setFileSendIndexCache=function(e){var t=void 0==e.sendIndex?0:e.sendIndex;window.localStorage.setItem(this.opt.key+e.name+e.lastModified,t)},t.prototype.resetFileSendIndexCache=function(e){window.localStorage.setItem(this.opt.key+e.name+e.lastModified,0)},t.prototype.clearAllFileSendIndexCache=function(){for(var e in window.localStorage)e.indexOf(this.opt.key)>=0&&delete window.localStorage[e];return this},t.prototype.resetFile=function(e){this.resetFileSendIndexCache(e),this.initFile(e)},t.prototype.resetFileByIndex=function(e){this.resetFileSendIndexCache(this.files[e]),this.initFile(this.files[e])},t.prototype.resetAllFile=function(){for(var e=0;e<this.files.length;e++)"faile"!==file.state&&"disable"!=file.state&&this.resetFile(this.files[e])},t.prototype.getPrecent=function(e){return Math.round(e.sendIndex/e.blockCount*100)},t.prototype.setFileState=function(e,t){e.state=t,this.queueNext(),this.opt.onFileStateChange(e,t)},t.prototype.startAll=function(){for(var e=0;e<this.files.length;e++){var t=this.files[e];"stop"!=t.state&&"wait"!=t.state||this.startUploadFile(t)}},t.prototype.stopAll=function(){for(var e=0;e<this.files.length;e++){var t=this.files[e];"uploading"!=t.state&&"wait"!=t.state||this.setFileState(t,"stop")}},t.prototype.state=function(){for(var e=this.files.length,t=0,o=0,i=0,n=0,s=0,l=0;l<this.files.length;l++)switch(this.files[l].state){case"disable":t++;break;case"error":0;break;case"stop":i++;break;case"wait":n++;break;case"uploading":s++;break;case"done":o++}return{total:e,enableCount:e-t,disableCount:t,stopCount:i,waitCount:n,uploadingCount:s,doneCount:o}}}var o={accept:"*/*",key:"_baseUpfile_",queueSize:2,preSize:"500",uploadURL:"uploadFile",drop:!1,dropId:"#baseUpfileDrop",inputButton:"#baseUpfileInput",onBeforeAddFile:function(e){},onLoadFile:function(e){},onAddFile:function(e){},onSameFile:function(e){},onUploading:function(e,t){},onUploadError:function(e,t,o){},onUploadDone:function(e){},onUploadAllDone:function(e){},onUploadStop:function(e){},onLastBlockIndex:function(e,t){},onFileStateChange:function(e,t){}},i={};return t});